const got = require("got")
const similarity = require('similarity')

function racentos(strAccents) {
    var strAccents = strAccents.split('');
    var strAccentsOut = new Array();
    var strAccentsLen = strAccents.length;
    var accents = 'ÀÁÂÃÄÅàáâãäåÒÓÔÕÕÖØòóôõöøÈÉÊËèéêëðÇçÐÌÍÎÏìíîïÙÚÛÜùúûüÑñŠšŸÿýŽž';
    var accentsOut = "AAAAAAaaaaaaOOOOOOOooooooEEEEeeeeeCcDIIIIiiiiUUUUuuuuNnSsYyyZz";
    for (var y = 0; y < strAccentsLen; y++) {
      if (accents.indexOf(strAccents[y]) != -1) {
        strAccentsOut[y] = accentsOut.substr(accents.indexOf(strAccents[y]), 1);
      } else
        strAccentsOut[y] = strAccents[y];
    }
    strAccentsOut = strAccentsOut.join('');
    return strAccentsOut;
  }
let customs = [

]


module.exports = {
    enseñar:async function(texto,respuesta,contraseña){
            if(!texto) return "debe decirme el texto";
            if(!respuesta) return "debe decirme la respuesta al texto";
            if(!contraseña){
                customs.push({input:texto,output:respuesta})
                return "Añadida con exito"
            } else {
            respuesta = encodeURIComponent(respuesta);
            var r;
           let bot = await got(`https://chatbotapi.glitch.me/api?tipo=post&contraseña=${contraseña}&texto=${texto}&respuesta=${respuesta}`)
            let datos = JSON.parse(bot.body)
            if(datos.resultado == "error") var r = "hubo un error"
            else var r = datos.resultado
          
            return r;
            }
    },
    hablar:async function(texto,modo){
        if(!texto) return "debe decirme el texto";
        if(typeof texto !== "string") return "El texto no debe ser un array"
        if(!modo){
            modo = 0
        }
        if(modo !== 0 && modo !== 1){
            modo = 0
        }
        texto = racentos(texto)
        let valores = customs.map(f => {return f.input}).map(f => {return similarity(f,texto)})
        if(valores.some(s => s > 0.6)){
            let maximo = Math.max(valores)
            let index = valores.indexOf(maximo)
            if(customs[index] == undefined){
                texto = encodeURIComponent(texto);
                let bot = await got(`https://chatbotapi.glitch.me/api?tipo=get&texto=${texto}`)
            let datos = JSON.parse(bot.body)
            if(datos.resultado == "error") var r = "hubo un error"
            else var r = datos.resultado
            let fecha = new Date()
            fecha = `${fecha.getDate()}/${fecha.getMonth()+1}/${fecha.getFullYear()}`
            r = r.replace(/{fechaactual}/g,fecha)
            r = decodeURIComponent(r)
            return r;
            } else {
            return customs[index].output
            }
        } else {
            texto = encodeURIComponent(texto);
            let bot = await got(`https://chatbotapi.glitch.me/api?tipo=get&modo=${modo}&texto=${texto}`)
        let datos = JSON.parse(bot.body)
        if(datos.resultado == "error") var r = "hubo un error"
        else var r = datos.resultado
        let fecha = new Date()
        fecha = `${fecha.getDate()}/${fecha.getMonth()+1}/${fecha.getFullYear()}`
        r = r.replace(/{fechaactual}/g,fecha)
        r = decodeURIComponent(r)
        return r;
    }

    },
    pendientes:async function(contraseña){
        if(!contraseña) return "debe decirme la contraseña";
       let bot = await got(`https://chatbotapi.glitch.me/api?tipo=pendientes&contraseña=${contraseña}`)
            let datos = JSON.parse(bot.body)
            if(datos.resultado == "error") var r = "hubo un error"
            else var r = datos.resultado
          
            return r;
    },
    todos:async function(contraseña){
        if(!contraseña) return "debe decirme la contraseña";
       let bot = await got(`https://chatbotapi.glitch.me/api?tipo=todos&contraseña=${contraseña}`)
            let datos = JSON.parse(bot.body)
            if(datos.resultado == "error") var r = "hubo un error"
            else var r = datos.resultado
          
            return r;
    },
    registro:async function(contraseña){
        if(!contraseña) return "debe decirme la contraseña";
       let bot = await got(`https://chatbotapi.glitch.me/api?tipo=registro&contraseña=${contraseña}`)
            let datos = JSON.parse(bot.body)
            if(datos.resultado == "nada") var r = "no hay nada en el registro"
            else var r = datos.resultado
            return r;
    },
    total:async function(){
        let bot = await got(`https://chatbotapi.glitch.me/api?tipo=ntotal`)
        let datos = JSON.parse(bot.body)
        return {total:datos.resultado1,asignados:datos.resultado2};
    }
}